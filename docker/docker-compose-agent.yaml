services:
  agent:
    container_name: configflow-agent
    build:
      context: .
      dockerfile: Dockerfile.agent
    image: thsrite/config-flow-agent:latest
    restart: always

    ports:
      # --- Agent 端口 ---
      # Agent for Mihomo
      - "58080:58080"
      # Agent for MosDNS
      - "58081:58081"

      # --- Service 端口 (根据你的需要暴露) ---
      # Mihomo 默认端口
      - "57890:7890"  # Mix Proxy
      - "57891:7891"  # HTTP(S) Proxy
      - "57892:7892"  # SOCKS5 Proxy
      - "59090:9090"  # External Controller API
      # MosDNS 默认端口
      - "55553:53/udp"  # DNS

    volumes:
      # !! 重要 !!: 将宿主机配置目录挂载到容器
      # 如果目录不存在，Docker 会自动创建
      - ./config/mihomo:/etc/mihomo
      - ./config/mosdns:/etc/mosdns

    environment:
      # --- 通用配置 ---
      - TZ=Asia/Shanghai
      - SERVER_URL=http://192.168.50.100:5801
      - HEARTBEAT_INTERVAL=15
      - AGENT_IP=192.168.50.100

      # --- Mihomo 控制 ---
      - ENABLE_MIHOMO=true  # 设置为 false 将完全禁用 mihomo 及其 agent
      - AGENT_MIHOMO_NAME=mihomo
      - AGENT_MIHOMO_PORT=58080  # 必须与上面 ports 部分匹配

      # --- MosDNS 控制 ---
      - ENABLE_MOSDNS=true  # 设置为 false 将完全禁用 mosdns 及其 agent
      - AGENT_MOSDNS_NAME=mosdns
      - AGENT_MOSDNS_PORT=58081  # 必须与上面 ports 部分匹配

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
